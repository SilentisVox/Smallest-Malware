# Theory
> Combining the DOS Header and PE Header into a compact structure allows for a minimal and stealthy malware footprint. By overlapping these headers, the malware can take advantage of the structure of a standard executable while minimizing the size of the malicious payload.

### Windows EXE Layout

<p>Traditional malware techniques involve manipulating various parts of the executable file format. This approach leverages the peculiarities of the DOS and PE headers, effectively "smashing" them together to reduce the overall size and avoid detection.</p>
<p>The goal is to have the entry point of the executable lead directly to the malicious code, bypassing the typical initialization procedures.</p>

```asm
; DOS Header                            
    dw 'MZ'                                 
    dw 0                                
    ...                                     
    dw Address_of_PE_Header             
; PE Header                             
    dw 'PE'
    dw 0
    ...
    dw Address_of_Entry                         
; Entry
    entry:
        db ... ; Shellcode

;; Into

; DOS Header
    dw 'MZ'
; PE Header
    dw 'PE'
    dw Address_of_PE_Header
    dw 0
    dw Address_of_Entry
; Entry
    entry:
        db ... ; Shellcode
```


### Process
<p><b>Step 1.</b> Define a minimal DOS and PE header combination.</p>
<p><b>Step 2.</b> Overlap the headers so that they share space, reducing the overall size.</p>
<p><b>Step 3.</b> Update the addresses so they point backwords</p>
<p><b>Step 3.</b> Place the malicious shellcode immediately after the headers.</p>
<p><b>Step 4.</b> Ensure the AddressOfEntryPoint in the PE header points directly to the shellcode.</p>
<p><b>Step 5.</b> Adjust the headers to maintain a valid executable structure while focusing on minimal size.</p> </html>


### Action

```asm
BITS 64

; DOS Header
    dw 'MZ'             ; MZ magic number
    dw 0                ; Padding to align with PE header

; PE Header
pe_hdr:
    dw 'PE', 0          ; PE signature
    dw 0x8664           ; Machine type: x64

code:

; Optional Header and Section Information
symbol:
    dw 0                ; Symbol table (not used)
    dq 0                ; Number of symbols (not used)
    dd 0                ; Time date stamp (not used)
    dw opt_hdr_size     ; Size of optional header
    dw 0x22             ; Characteristics

opt_hdr:
    dw 0x020b           ; PE32+ (64-bit executable)
    dw 0                ; Linker version
    dd code_size        ; Size of the code section
    dq 0                ; Initialized data size
    dd entry            ; Entry point (address of the shellcode)
    dd code             ; Base of code section
    dq 0x000140000000   ; Image base
    dd pe_hdr           ; Address of PE header
    dd 0x04             ; Section alignment
    dq 0                ; File alignment
    dw 0x06             ; Major and minor OS versions
    dw 0                ; Major and minor image versions
    dd 0                ; Major and minor subsystem versions
    dd file_size        ; Size of the entire file
    dd hdr_size         ; Size of headers
    dd 0                ; Checksum (optional)
    dw 0x02             ; Subsystem (Windows GUI)
    dw 0                ; DLL characteristics (none)
    dq 0                ; Size of stack reserve
    dq 0                ; Size of stack commit
    dq 0                ; Size of heap reserve
    dq 0                ; Size of heap commit
    dd 0                ; Loader flags (none)
    dd 0x02             ; Number of RVAs and sizes
    dq 0                ; Data directory (export table)
    dq 0                ; Data directory (import table)
opt_hdr_size equ $-opt_hdr
    dq 0                ; Virtual address
    dd sect_size        ; Size of section
    dd 0                ; Pointer to raw data
    dd code_size        ; Size of raw data
    dd 0                ; Pointer to relocations
    dq 0                ; Pointer to line numbers
    dq 0                ; Number of relocations
    dq 0                ; Number of line numbers

hdr_size equ $-$$

entry:
    db ;... Shellcode here   ; This is where the malicious code starts

sect_size equ $-code
code_size equ $-code
file_size equ $-$$
```
